<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cargando — TechCareer</title>

<style>
:root{
  --bg-1:#04121a;
  --bg-2:#081e27;
  --muted:#9fbfc1;
  --accent:#6ef1d4;
  --accent-2:#3fb7ff;
}
*{box-sizing:border-box}
html,body{
  height:100%;
  margin:0;
  font-family:Inter,system-ui,Arial;
  background:linear-gradient(180deg,var(--bg-1),var(--bg-2));
  color:#e9f9f7;
  overflow:hidden
}

.wrapper{
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  padding:36px;
  gap:28px
}

/* CARD */
.card{
  width:100%;
  max-width:1120px;
  border-radius:18px;
  background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
  border:1px solid rgba(255,255,255,0.04);
  padding:30px;
  display:flex;
  gap:28px;
  align-items:center;
  box-shadow:0 30px 80px rgba(3,18,22,0.6);
  backdrop-filter:blur(10px);
}

/* LEFT */
.canvas-wrap{
  flex:1;
  min-height:260px;
  position:relative;
}

.neural-canvas{
  width:100%;
  height:260px;
  border-radius:12px;
  background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);
  border:1px solid rgba(255,255,255,0.02)
}

/* FAKE BARS */
.fake-bars{
  position:absolute;
  bottom:16px;
  left:16px;
  right:16px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.bar{
  height:10px;
  border-radius:8px;
  background:rgba(255,255,255,0.04);
  overflow:hidden;
  border:1px solid rgba(255,255,255,0.05);
}

.bar span{
  display:block;
  height:100%;
  width:0%;
  border-radius:8px;
  background:linear-gradient(90deg,var(--accent),var(--accent-2));
  box-shadow:0 0 14px rgba(110,241,212,0.35);
  transition:width .3s ease;
}

/* RIGHT */
.info{
  width:360px;
  display:flex;
  flex-direction:column;
  gap:14px
}

.brand-top{
  display:flex;
  gap:12px;
  align-items:center
}

.logo{
  width:56px;
  height:56px;
  border-radius:12px;
  overflow:hidden
}
.logo img{
  width:100%;
  height:100%;
  object-fit:cover
}

.h-title{font-weight:900;font-size:20px}
.h-sub{color:var(--muted);font-size:13px}

/* RING */
.ring-wrap{
  display:flex;
  gap:14px;
  align-items:center;
  margin-top:10px
}

.ring{
  width:110px;
  height:110px;
  position:relative;
  display:flex;
  align-items:center;
  justify-content:center
}

.ring svg{transform:rotate(-90deg)}
.ring .num{
  position:absolute;
  font-weight:900;
  font-size:22px
}

/* STEPS */
.steps{
  margin-top:14px;
  border-radius:12px;
  padding:12px;
  background:rgba(255,255,255,0.01);
  border:1px solid rgba(255,255,255,0.02)
}
.step{
  display:flex;
  gap:12px;
  align-items:center;
  padding:8px;
  border-radius:10px
}
.step .dot{
  width:12px;
  height:12px;
  border-radius:50%;
  background:rgba(255,255,255,0.05)
}
.step .text{font-size:13px;color:var(--muted)}

.message{
  margin-top:14px;
  color:var(--muted);
  font-size:14px;
  min-height:34px
}

.controls{
  display:flex;
  justify-content:flex-end
}

.btn{
  padding:8px 12px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.06);
  background:rgba(255,255,255,0.02);
  color:inherit;
  cursor:pointer
}

@media(max-width:980px){
  .card{flex-direction:column}
  .info{width:100%}
}

/* BAR LABELS */
.bar-row{
  display:flex;
  flex-direction:column;
  gap:4px;
}

.bar-label{
  font-size:11px;
  color:rgba(159,191,193,0.75);
  letter-spacing:.2px;
}

</style>
</head>

<body>
<div class="wrapper">

  <div class="card">

    <!-- LEFT -->
    <div class="canvas-wrap">
      <div class="neural-canvas"></div>

<div class="fake-bars">
  <div class="bar-row">
    <div class="bar-label">Inicializando pipeline</div>
    <div class="bar"><span></span></div>
  </div>
  <div class="bar-row">
    <div class="bar-label">Extrayendo texto</div>
    <div class="bar"><span></span></div>
  </div>
  <div class="bar-row">
    <div class="bar-label">Detectando skills</div>
    <div class="bar"><span></span></div>
  </div>
  <div class="bar-row">
    <div class="bar-label">Matching de roles</div>
    <div class="bar"><span></span></div>
  </div>
  <div class="bar-row">
    <div class="bar-label">Estimando seniority</div>
    <div class="bar"><span></span></div>
  </div>
</div>

    </div>

    <!-- RIGHT -->
    <div class="info">
      <div class="brand-top">
        <div class="logo">
          <img src="/screens/logo.webp" alt="TechCareer">
        </div>
        <div>
          <div class="h-title">Procesando tu CV</div>
          <div class="h-sub">La IA está analizando tu perfil</div>
        </div>
      </div>

      <div class="ring-wrap">
        <div class="ring">
          <svg width="110" height="110" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="44" stroke="rgba(255,255,255,0.04)" stroke-width="12" fill="none"/>
            <circle id="progressCircle" cx="50" cy="50" r="44"
              stroke="url(#grad)" stroke-width="12" stroke-linecap="round"
              fill="none" stroke-dasharray="276.46" stroke-dashoffset="276.46"/>
            <defs>
              <linearGradient id="grad">
                <stop offset="0" stop-color="#6ef1d4"/>
                <stop offset="1" stop-color="#3fb7ff"/>
              </linearGradient>
            </defs>
          </svg>
          <div class="num" id="pct">0%</div>
        </div>

        <div>
          <div style="font-size:12px;color:var(--muted)">Estado</div>
          <div id="currentPhase" style="font-weight:800;margin-top:6px">
            Inicializando…
          </div>
        </div>
      </div>

      <div class="message" id="message">Preparando análisis…</div>

      <div class="controls">
        <button class="btn" id="cancelBtn">Cancelar</button>
      </div>
    </div>

  </div>

</div>

<script>
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

(async function(){

  const API_URL = "http://127.0.0.1:8001/api/v1/cv/test-analyze";
  const RESULTS_URL = "/screens/particulares/results/results.html";
  const HOME_URL = "/screens/particulares/home.html";

  const pctEl = document.getElementById("pct");
  const circle = document.getElementById("progressCircle");
  const phaseEl = document.getElementById("currentPhase");
  const msgEl = document.getElementById("message");
  const cancelBtn = document.getElementById("cancelBtn");

  cancelBtn.onclick = ()=>location.href = HOME_URL;

  const circumference = 2 * Math.PI * 44;
  function setPct(p){
    pctEl.textContent = Math.round(p)+"%";
    circle.style.strokeDashoffset = circumference * (1 - p/100);
  }

  // fake progress 5s
  const fakeProgress = async () => {
    const start = performance.now();
    while(true){
      const p = Math.min(((performance.now()-start)/5000)*100,100);
      setPct(p);
      if(p>=100) break;
      await sleep(50);
    }
  };

  // fake bars
  const bars = document.querySelectorAll(".bar span");
  let running = true;
  (async()=>{
    while(running){
      bars.forEach(b=>b.style.width = (Math.random()*90+10)+"%");
      await sleep(300);
    }
  })();

  // backend
  const callBackend = async () => {
    const cvFile = sessionStorage.getItem("cvFile");
    if(!cvFile) throw new Error("CV no encontrado");

    const bytes = atob(cvFile.split(",")[1]);
    const arr = new Uint8Array(bytes.length);
    for(let i=0;i<bytes.length;i++) arr[i]=bytes.charCodeAt(i);

    const fd = new FormData();
    fd.append("file", new Blob([arr],{type:"application/pdf"}), "cv.pdf");

    const res = await fetch(API_URL,{method:"POST",body:fd});
    const json = await res.json();
    sessionStorage.setItem("cvResult", JSON.stringify(json));
  };

  try{
    await Promise.all([fakeProgress(), callBackend()]);
    running = false;
    bars.forEach(b=>b.style.width="100%");
    msgEl.textContent = "Redirigiendo…";
    await sleep(400);
    location.href = RESULTS_URL;
  }catch(e){
    alert("Error analizando CV");
    location.href = HOME_URL;
  }

})();
const fakeTexts = [
  "Tokenizando CV",
  "Normalizando experiencia",
  "Extrayendo skills técnicas",
  "Clasificando tecnologías",
  "Calculando seniority",
  "Matching con roles",
  "Analizando mercado salarial",
  "Generando insights",
  "Optimizando resultados"
];

const labels = document.querySelectorAll(".bar-label");

const animateLabels = async () => {
  while (running) {
    labels.forEach(label => {
      const t = fakeTexts[Math.floor(Math.random() * fakeTexts.length)];
      label.textContent = t;
    });
    await sleep(900 + Math.random() * 600);
  }
};
animateLabels();

</script>
</body>
</html>
